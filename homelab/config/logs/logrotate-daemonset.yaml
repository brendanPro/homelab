apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: logrotate
  namespace: kube-system
  labels:
    app: logrotate
spec:
  selector:
    matchLabels:
      app: logrotate
  template:
    metadata:
      labels:
        app: logrotate
    spec:
      hostNetwork: true
      hostPID: true
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node.kubernetes.io/disk-pressure
        operator: Exists
        effect: NoSchedule
      - key: node.kubernetes.io/memory-pressure
        operator: Exists
        effect: NoSchedule
      - key: node.kubernetes.io/not-ready
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 300
      - key: node.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 300
      containers:
      - name: logrotate
        image: alpine:3.18
        command:
        - /bin/sh
        - -c
        - |
          # Install logrotate
          apk add --no-cache logrotate
          
          # Create log directories if they don't exist
          mkdir -p /host/var/log/apps
          
          # Run logrotate every hour
          while true; do
            echo "$(date): Running logrotate..."
            /usr/sbin/logrotate -v /etc/logrotate.conf
            
            # Also run journalctl vacuum to clean old logs
            if command -v journalctl >/dev/null 2>&1; then
              echo "$(date): Cleaning journal logs..."
              chroot /host journalctl --vacuum-time=7d --vacuum-size=500M
            fi
            
            echo "$(date): Logrotate completed. Sleeping for 1 hour..."
            sleep 3600
          done
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        securityContext:
          privileged: true
          runAsUser: 0
        volumeMounts:
        - name: logrotate-config
          mountPath: /etc/logrotate.conf
          subPath: logrotate.conf
        - name: host-var-log
          mountPath: /host/var/log
        - name: host-var-lib
          mountPath: /host/var/lib
        - name: host-root
          mountPath: /host
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
      volumes:
      - name: logrotate-config
        configMap:
          name: logrotate-config
      - name: host-var-log
        hostPath:
          path: /var/log
          type: Directory
      - name: host-var-lib
        hostPath:
          path: /var/lib
          type: Directory
      - name: host-root
        hostPath:
          path: /
          type: Directory
      restartPolicy: Always
